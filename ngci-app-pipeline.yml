---
resource_types:
- name: kubernetes
  type: docker-image
  source:
    repository: zlabjp/kubernetes-resource
    tag: "1.9"


resources:
- name: skeleton
  type: git
  source:
    uri: https://github.com/silvam11/ngci-app
    branch: russed5-update
    check_every: 5m
    skip_ssl_verification: true

# - name: resource-pytest
  # type: git
  # source:
    # uri: https://eos2git.cec.lab.emc.com/VCE-Symphony/revere-seed3-papp
    # branch: master
    # username: ((RegistryUser))
    # password: ((RegistryPass))
    # skip_ssl_verification: true

- name: k8s
  type: kubernetes
  source:
    server: ((k8s-server))
    token: ((k8stoken))
    certificate_authority: ((k8scertificate))

- name: web-gateway-image
  type: docker-image
  source:
    repository: ((k8s-registry))/ngci/web-gateway
    insecure_registries: [ "((k8s-registry))" ]

- name: system-model-image
  type: docker-image
  source:
    repository: ((k8s-registry))/ngci/system-model
    insecure_registries: [ "((k8s-registry))" ]

jobs:
# Unit tests need to be written
# - name: job-unit-test
  # public: true
  # serial: true
  # plan:
  # - get: skeleton
    # trigger: true
  # - task: unittests
    # file: skeleton/task_run_tests.yml

- name: job-build-web-gateway
  public: true
  serial: true
  plan:
  - get: skeleton
    # passed: [job-unit-test]
    trigger: true
  - task: buildexecutable
    params:
      SERVICE_NAME: web-gateway
    file: skeleton/ci_tasks/task_build_executable.yml
  - put: web-gateway-image
    params:
      tag: skeleton/version.txt
      build: binaries

- name: job-build-system-model
  public: true
  serial: true
  plan:
  - get: skeleton
    # passed: [job-unit-test]
    trigger: true
  - task: buildexecutable
    params:
      SERVICE_NAME: system-model
    file: skeleton/ci_tasks/task_build_executable.yml
  - put: system-model-image
    params:
      tag: skeleton/version.txt
      build: binaries

- name: job-k8s-test
  public: true
  serial: true
  plan:
  - get: skeleton
    passed: [job-build-web-gateway]
    passed: [job-build-system-model]
    trigger: true
  - put: k8s
    params:
      kubectl: apply -f skeleton/namespace.yml
  - put: k8s
    params:

      kubectl: apply -f skeleton/deployments.yml
      namespace: ngci
      wait_until_ready: 90
      wait_until_ready_selector: app=web-gateway
      wait_until_ready_selector: app=system-model
    on_failure:
      put: k8s
      params:
        kubectl: delete -f skeleton/deployments.yml
  - put: k8s
    params:
      kubectl: apply -f skeleton/services.yml
      namespace: ngci
  - put: k8s
    params:
      kubectl: apply -f skeleton/ngci-gateway.yml
      namespace: ngci
  - put: k8s
    params:
      kubectl: apply -f skeleton/ngci-virtual-service.yml
      namespace: ngci


# - name: test1
  # public: true
  # plan:
  # - get: resource-pytest
    # trigger: true
  # - task: test1task1
    # params:
      # TEST_SUITE_NAME: SampleCode
      # TEST_SUITE_TYPE: ((test-suite-type))
      # TEST_ENV: ((test-environment))
    # file: resource-pytest/integtest.yml

# - name: test2
  # public: true
  # plan:
  # - get: resource-pytest
    # passed: [test1]
    # trigger: true
  # - task: test2task1
    # params:
      # TEST_SUITE: ((test-suite))
      # TEST_ENV: ((test-environment))
    # file: resource-pytest/integtest.yml
